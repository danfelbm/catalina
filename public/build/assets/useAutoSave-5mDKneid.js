import{t as A}from"./index-C1n5YpSv.js";import{k as U,c as N,w as X}from"./app-C-ljWtfy.js";var H=typeof global=="object"&&global&&global.Object===Object&&global,z=typeof self=="object"&&self&&self.Object===Object&&self,B=H||z||Function("return this")(),$=B.Symbol,G=Object.prototype,Q=G.hasOwnProperty,V=G.toString,L=$?$.toStringTag:void 0;function Y(e){var n=Q.call(e,L),s=e[L];try{e[L]=void 0;var d=!0}catch{}var g=V.call(e);return d&&(n?e[L]=s:delete e[L]),g}var Z=Object.prototype,ee=Z.toString;function te(e){return ee.call(e)}var re="[object Null]",ne="[object Undefined]",P=$?$.toStringTag:void 0;function oe(e){return e==null?e===void 0?ne:re:P&&P in Object(e)?Y(e):te(e)}function ae(e){return e!=null&&typeof e=="object"}var se="[object Symbol]";function ie(e){return typeof e=="symbol"||ae(e)&&oe(e)==se}var ce=/\s/;function ue(e){for(var n=e.length;n--&&ce.test(e.charAt(n)););return n}var le=/^\s+/;function de(e){return e&&e.slice(0,ue(e)+1).replace(le,"")}function _(e){var n=typeof e;return e!=null&&(n=="object"||n=="function")}var M=NaN,fe=/^[-+]0x[0-9a-f]+$/i,ge=/^0b[01]+$/i,me=/^0o[0-7]+$/i,ve=parseInt;function q(e){if(typeof e=="number")return e;if(ie(e))return M;if(_(e)){var n=typeof e.valueOf=="function"?e.valueOf():e;e=_(n)?n+"":n}if(typeof e!="string")return e===0?e:+e;e=de(e);var s=ge.test(e);return s||me.test(e)?ve(e.slice(2),s?2:8):fe.test(e)?M:+e}var W=function(){return B.Date.now()},pe="Expected a function",Se=Math.max,be=Math.min;function Te(e,n,s){var d,g,b,u,a,l,v=0,o=!1,T=!1,E=!0;if(typeof e!="function")throw new TypeError(pe);n=q(n)||0,_(s)&&(o=!!s.leading,T="maxWait"in s,b=T?Se(q(s.maxWait)||0,n):b,E="trailing"in s?!!s.trailing:E);function w(t){var f=d,p=g;return d=g=void 0,v=t,u=e.apply(p,f),u}function R(t){return v=t,a=setTimeout(y,n),o?w(t):u}function C(t){var f=t-l,p=t-v,x=n-f;return T?be(x,b-p):x}function I(t){var f=t-l,p=t-v;return l===void 0||f>=n||f<0||T&&p>=b}function y(){var t=W();if(I(t))return O(t);a=setTimeout(y,C(t))}function O(t){return a=void 0,E&&d?w(t):(d=g=void 0,u)}function F(){a!==void 0&&clearTimeout(a),v=0,d=l=g=a=void 0}function j(){return a===void 0?u:O(W())}function k(){var t=W(),f=I(t);if(d=arguments,g=this,l=t,f){if(a===void 0)return R(l);if(T)return clearTimeout(a),a=setTimeout(y,n),w(l)}return a===void 0&&(a=setTimeout(y,n)),u}return k.cancel=F,k.flush=j,k}function Ee(e,n){const{url:s,resourceId:d=null,resourceIdField:g="candidatura_id",debounceTime:b=3e3,showNotifications:u=!0,useLocalStorage:a=!0,localStorageKey:l="draft",additionalData:v={}}=n,o=U({status:"idle",lastSaved:null,lastError:null,resourceId:d}),T=N(()=>o.value.status==="saving"),E=N(()=>o.value.lastSaved!==null),w=N(()=>o.value.status==="error"),R=()=>{if(a)try{const r={data:e.value,timestamp:new Date().toISOString(),resourceId:o.value.resourceId,additionalData:v};localStorage.setItem(l,JSON.stringify(r))}catch(r){console.error("Error guardando en localStorage:",r)}},C=()=>{if(!a)return null;try{const r=localStorage.getItem(l);if(r){const i=JSON.parse(r),S=new Date(i.timestamp);if((Date.now()-S.getTime())/(1e3*60*60)<24)return i;localStorage.removeItem(l)}}catch(r){console.error("Error cargando desde localStorage:",r)}return null},I=()=>{a&&localStorage.removeItem(l)},y=async()=>{try{const r=await fetch(window.location.href,{method:"GET",credentials:"same-origin"});if(r.ok){const i=await r.text(),c=new DOMParser().parseFromString(i,"text/html").querySelector('meta[name="csrf-token"]');if(c){const h=c.getAttribute("content"),D=document.querySelector('meta[name="csrf-token"]');if(D&&h)return D.setAttribute("content",h),h}}}catch(r){console.error("Error renovando token CSRF:",r)}return null},O=async(r,i,S=0)=>{const m=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":i,Accept:"application/json"},credentials:"same-origin",body:JSON.stringify({...v,formulario_data:e.value,respuestas:e.value})});if(m.status===419&&S<1){const c=await y();if(c)return u&&A.info("Renovando sesión...",{description:"Se detectó una sesión expirada, renovando automáticamente",duration:2e3}),O(r,c,S+1)}return m},F=async()=>{var r;if(o.value.status!=="saving"&&!(!e.value||Object.keys(e.value).length===0)){o.value.status="saving",o.value.lastError=null;try{const i=o.value.resourceId?s.replace("autosave",`${o.value.resourceId}/autosave`):s,S=((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content"))||"";if(!S)throw new Error("Token CSRF no encontrado");const m=await O(i,S);if(!m.ok)throw new Error(`Error ${m.status}: ${m.statusText}`);const c=await m.json();if(c.success){if(o.value.status="saved",o.value.lastSaved=new Date,!o.value.resourceId){const h=c[g]||c.respuesta_id||c.candidatura_id||c.id;h&&(o.value.resourceId=h)}R(),u&&A.success("Cambios guardados",{description:`Autoguardado a las ${c.timestamp||new Date().toLocaleTimeString()}`,duration:2e3})}else throw new Error(c.message||"Error al guardar")}catch(i){o.value.status="error",o.value.lastError=i instanceof Error?i.message:"Error desconocido",R(),i instanceof Error&&i.message.includes("419")?u&&A.warning("Sesión expirada",{description:"Recarga la página para continuar. Los cambios se guardaron localmente.",duration:5e3}):u&&A.error("Error al guardar",{description:"Los cambios se guardaron localmente",duration:3e3}),console.error("Error en autoguardado:",i)}}},j=Te(F,b),k=()=>(j.cancel(),F());let t=null;const f=()=>(t&&t(),t=X(e,()=>{o.value.status!=="error"&&j()},{deep:!0}),t),p=()=>{j.cancel(),t&&(t(),t=null)},x=p,J=()=>{x(),o.value={status:"idle",lastSaved:null,lastError:null,resourceId:d},I()},K=()=>{const r=C();return r&&(r.data||r.formulario_data)?(u&&A.info("Borrador recuperado",{description:"Se recuperaron los cambios no guardados",duration:3e3}),{...r,data:r.data||r.formulario_data}):null};return{state:N(()=>o.value),isSaving:T,hasSaved:E,hasError:w,saveNow:k,startWatching:f,stopWatching:p,stopAutoSave:x,reset:J,restoreDraft:K,clearLocalStorage:I}}export{Ee as u};
